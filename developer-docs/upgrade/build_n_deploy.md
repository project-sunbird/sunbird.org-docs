---
title: Build and Deploy
page_title: Build and Deploy
description: Build and Deploy
published: true
allowSearch: true
keywords: Upgrade, Sunbird 3.9.0
---

## Overview

This page details out the jobs required to be run as part of the upgrade from Sunbird release 3.7.0 to release 3.8.0. Use the following table to understand the jobs that need to be executed in order to successfully complete the upgrade. Any jenkins job configuration or pre-requisites mentioned under manual configuration section needs to be done first before running any of the mentioned jobs. The order of the jobs should also be run as shown below. They can be run in parallel to speed up the execution.

### Variables

| Variable Name                                | Service Name          | Comments                                                  |
|----------------------------------------------|-----------------------|-----------------------------------------------------------|
| assessaggregator_scoreaggregator_parallelism | DataPipelineFlinkJobs | value to be same as assessaggregator_consumer_parallelism |

### Build and Deploy

| Service to be Build           | Build Tag                                     | Service to Deploy                       | Deploy Tag                                     | Comments                                                                          |
|-------------------------------|-----------------------------------------------|-----------------------------------------|------------------------------------------------|-----------------------------------------------------------------------------------|
| KnowledgePlatform - FlinkJobs | release-3.9.0_RC1                             | audit-history-indexer                   | Public branch: release-3.9.0_RC1               |                                                                                   |
| sunbird-ed-dataproduct        | release-3.9.0_RC2                             | sunbird-ed-dataproduct                  | release-3.9.0_RC1                              |                                                                                   |
| DataPipleline fink job        | release-3.9.0_RC2                             | assessment-aggregator                   | release-3.9.0_RC2                              |                                                                                   |
| Cassandra DB Update           | NA                                            | KnowledgePlatform/job/CassandraDbUpdate | sunbird-learning-platform : release-3.9.0_RC2  |                                                                                   |
| Upload Schema                 | NA                                            | kubernetes/uploadSchema                 | kp branch: release-3.9.0_RC2                   |                                                                                   |
| KnowledgePlatform - FlinkJobs | knowledge-platform-jobs : release-3.9.0_RC2   | asset-enrichment                        | sunbird-learning-platform : release-3.9.0_RC2  | Please kill asset-enrichment samza job and delete jars from main/extracted folder |
|                               | NA                                            | OnboardAPI                              | sunbird-devops : release-3.9.0_RC4             |                                                                                   |
| Cassandra migration           | sunbird-utils : release-3.9.0_RC1             | Cassandra migration                     | sunbird-devops : release-3.9.0                 |                                                                                   |
| EdDataproducts                | release-3.9.0_RC4                             | EdDataproducts                          | release-3.9.0_RC4                              |                                                                                   |
| SyncTool                      | sunbird-learning-platform : release-3.9.0_RC4 | Neo4jESSyncTool                         | sunbird-learning-platform : release-3.9.0_RC4  |                                                                                   |
| Upload Schema                 | NA                                            | kubernetes/uploadSchema                 | kp branch: release-3.9.0_RC3                   |                                                                                   |
| KnowledgePlatform - FlinkJobs | knowledge-platform-jobs : release-3.9.0_RC3   | quesstionset-publish                    | sunbird-learning-platform : release-3.9.0_RC4  |                                                                                   |
| KnowledgePlatform - FlinkJobs | knowledge-platform-jobs : release-3.9.0_RC3   | activity-aggregator-updater             | sunbird-learning-platform : release-3.9.0_RC6  |                                                                                   |
| SyncTool                      | sunbird-learning-platform : release-3.9.0_RC5 | Neo4jESSyncTool                         | sunbird-learning-platform : release-3.9.0_RC5  |                                                                                   |
| bot                           | release-3.9.0_RC1                             | bot                                     | release-3.9.0_RC1                              |                                                                                   |
| router                        | release-3.9.0_RC1                             | router                                  | release-3.9.0_RC1                              |                                                                                   |
| OnBoardAPI                    | sunbird-devops: release-3.9.0_RC2             |                                         | release-3.9.0_RC2                              |                                                                                   |
| Upload Schema                 | NA                                            | kubernetes/uploadSchema                 | kp branch: release-3.9.0                       |                                                                                   |
| Neo4j Schema Update           | NA                                            | KnowledgePlatform/Neo4jDefinitionUpdate | kp branch: release-3.9.0                       |                                                                                   |
| EdDataproducts                | release-3.9.0_RC5                             | EdDataproducts                          | release-3.9.0_RC3                              |                                                                                   |
|                               |                                               | DP FlinkPipelineJobs                    | release-3.9.0_RC4                              |                                                                                   |
|                               |                                               | KP FlinkJobs                            | release-3.9.0_RC7                              |                                                                                   |
|                               |                                               | OnboardAPIs                             | release-3.9.0_RC6                              |                                                                                   |
|                               |                                               | postgres-managed                        | release-3.9.0_RC5                              |                                                                                   |
| SyncTool                      | sunbird-learning-platform : release-3.9.0_RC4 | Neo4jESSyncTool                         | sunbird-learning-platform : release-3.9.0_RC4  | Sync for objectType = Framework and License                                       |
| Upload Schema                 | NA                                            | kubernetes/uploadSchema                 | kp branch: release-3.9.0_RC5                   |                                                                                   |
| Desktop app                   | release-3.9.0_RC35                            | Deploy/staging/OfflineInstaller         | release-3.9.0_RC6                              |                                                                                   |
|                               |                                               | Keycloak                                | release-3.9.0                                  |                                                                                   |
| LMS Service                   | sunbird-course-service : release-3.9.0_RC5    | LMS Service                             | sunbird-course-service : release-3.9.0_RC5     |                                                                                   |
| KnowledgePlatform - FlinkJobs | release-3.9.0_RC4                             | Video Streaming Job                     | sunbird-learning-platform : release-3.9.0_RC9  |                                                                                   |
| KnowledgePlatform - FlinkJobs | release-3.9.0_RC5                             | Video Streaming Job                     | sunbird-learning-platform : release-3.9.0_RC10 |                                                                                   |
| Upload Schema                 | NA                                            | kubernetes/uploadSchema                 | kp branch: release-3.9.0_RC9                   |                                                                                   |
| Neo4j Schema Update           | NA                                            | KnowledgePlatform/Neo4jDefinitionUpdate | sunbird-learning-platform: release-3.9.0_RC10  |                                                                                   |
| KnowledgePlatform - FlinkJobs | release-3.9.0_RC6                             | All KP Flink Jobs                       | sunbird-learning-platform : release-3.9.0_RC11 |                                                                                   |
|                               |                                               |                                         |                                                |                                                                                   |
| DataPipleline fink job        | release-3.9.0_RC5                             | deploy only user-cache-updater-v2      
| release-3.9.0_RC5                              |                                                                                   |


### Manual Configurations

| Manual Step                                                                                            | Instruction                                                                                                                                                                      |
|--------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Please add audit-history-indexer in KnowledgePlatform - FlinkJobs                                      |                                                                                                                                                                                  |
| Mobile (app-faq) - Please upload the json(will share via slack) in this blob location                  |                                                                                                                                                                                  |
| Mobile (portal-faq) - Please upload the json(will share via slack) in this blob location               |                                                                                                                                                                                  |
| Mobile (desktop-faq) - Please upload the json(will share via slack) in this blob location              |                                                                                                                                                                                  |
| "Update system settings with following request  https://project-sunbird.atlassian.net/browse/SB-24300" |                                                                                                                                                                                  |
| Truncate fed_user_attribute table                                                                      | "Take the backup first using the command pg_dump --host=PG_HOST --port=5432 --username=$PG_USER -d KEYCLOAK7_DB -t fed_user_attribute  > fed_user_attribute.sql"                 |
| Create / Update jenkins jobs                                                                           | https://github.com/project-sunbird/sunbird-devops/tree/release-3.9.0/deploy/jenkins/jobs/Provision/jobs/dev/jobs/Core/jobs/Graylog                                               |
|                                                                                                        | https://github.com/project-sunbird/sunbird-devops/tree/release-3.9.0/deploy/jenkins/jobs/OpsAdministration/jobs/dev/jobs/Core/jobs/GraylogGeoIP                                  |
|                                                                                                        | https://github.com/project-sunbird/sunbird-devops/tree/release-3.9.0/deploy/jenkins/jobs/OpsAdministration/jobs/dev/jobs/Core/jobs/MongoRestore                                  |
|                                                                                                        | https://github.com/project-sunbird/sunbird-devops/tree/release-3.9.0/deploy/jenkins/jobs/OpsAdministration/jobs/dev/jobs/Core/jobs/Bootstrap                                     |
|                                                                                                        | https://github.com/project-sunbird/sunbird-devops/tree/release-3.9.0/deploy/jenkins/jobs/Deploy/jobs/dev/jobs/Kubernetes/jobs/Logging                                            |
|                                                                                                        | https://github.com/project-sunbird/sunbird-devops/tree/7503594c489a444dd751fa91394aa612a5af9a72/deploy/jenkins/jobs/OpsAdministration/jobs/dev/jobs/Core/jobs/GraylogMongoImport |
| Create new VMs (esnure to increase disk size for loges new vm)                                         | "We will be creating 1 VM for graylog and 1 VM for new Log ES                                                                                                                    |
|                                                                                                        | Graylog size - Standard F2s_v2 (2 vcpus, 4 GiB memory)                                                                                                                           |
|                                                                                                        | Log ES size - Standard D2s v3 (2 vcpus, 8 GiB memory)"                                                                                                                           |
| Update the inventory for new hosts and variables                                                       | "[log-es-1]                                                                                                                                                                      |
|                                                                                                        | 11.3.2.27 node_name=log-es-1 es_instance_name=log-es-1 es_etc_node_master=true es_etc_node_data=true                                                                             |
|                                                                                                        | [log-es:children]                                                                                                                                                                |
|                                                                                                        | log-es-1                                                                                                                                                                         |
|                                                                                                        | [graylog-1]                                                                                                                                                                      |
|                                                                                                        | 11.3.2.28 mongodb_master=True graylog_is_master=True                                                                                                                             |
|                                                                                                        | [graylog:children]                                                                                                                                                               |
|                                                                                                        | graylog-1"                                                                                                                                                                       |
|                                                                                                        |                                                                                                                                                                                  |
|                                                                                                        | "Update the [log-es] group with the new                                                                                                                                          |
|                                                                                                        | Log ES VM IP in Core, KP and DP hosts files                                                                                                                                      |
|                                                                                                        |                                                                                                                                                                                  |
|                                                                                                        | Ensure both graylog and the new log-es VM                                                                                                                                        |
|                                                                                                        | are part of the node-exporter group"                                                                                                                                             |
|                                                                                                        |                                                                                                                                                                                  |
|                                                                                                        | "Add in Core, KP, DP hosts file                                                                                                                                                  |
|                                                                                                        |                                                                                                                                                                                  |
|                                                                                                        | If you want to reuse same machine, ensure                                                                                                                                        |
|                                                                                                        | invntory file is updated from log-es-2 to                                                                                                                                        |
|                                                                                                        | log-es-1"                                                                                                                                                                        |
| Add graylog variables                                                                                  | graylog_elasticsearch_discovery_enabled: "true"                                                                                                                                  |
|                                                                                                        | graylog_allow_leading_wildcard_searches: "true"                                                                                                                                  |
|                                                                                                        | graylog_elasticsearch_output_batch_size: 500                                                                                                                                     |
|                                                                                                        | graylog_elasticsearch_max_total_connections: 20                                                                                                                                  |
|                                                                                                        | graylog_elasticsearch_max_total_connections_per_route: 2                                                                                                                         |
|                                                                                                        | graylog_outputbuffer_processor_threads_core_pool_size: 3                                                                                                                         |
|                                                                                                        | graylog_outputbuffer_processor_threads_max_pool_size: 30                                                                                                                         |
|                                                                                                        | graylog_async_eventbus_processors: 1                                                                                                                                             |
|                                                                                                        | graylog_inputbuffer_processors: 1                                                                                                                                                |
|                                                                                                        | graylog_processbuffer_processors: 2                                                                                                                                              |
|                                                                                                        | graylog_outputbuffer_processors: 1                                                                                                                                               |
|                                                                                                        | graylog_allow_highlighting: "true"                                                                                                                                               |
|                                                                                                        | graylog_message_journal_dir: "/mnt/graylog-server/journal"                                                                                                                       |
|                                                                                                        | graylog_message_journal_max_size: "10gb"                                                                                                                                         |
|                                                                                                        | graylog_transport_email_enabled: "true"                                                                                                                                          |
|                                                                                                        | graylog_transport_email_hostname: "{{ mail_server_host }}"                                                                                                                       |
|                                                                                                        | graylog_transport_email_auth_username: "apikey"                                                                                                                                  |
|                                                                                                        | graylog_transport_email_from_email: "{{ sunbird_mail_server_from_email }}"                                                                                                       |
|                                                                                                        | graylog_server_heap_size: "1500m"                                                                                                                                                |
|                                                                                                        | graylog_gc_warning_threshold: "10s"                                                                                                                                              |
|                                                                                                        | graylog_root_timezone: "Asia/Kolkata"                                                                                                                                            |
|                                                                                                        | graylog_transport_email_use_ssl: "false"                                                                                                                                         |
|                                                                                                        | graylog_trusted_proxies: "11.3.8.0/21" # This should be the kubernetes subnet                                                                                                    |
|                                                                                                        | graylog_open_to_public: true  # Not for Diksha                                                                                                                                   |
|                                                                                                        | send_logs_to_graylog: true                                                                                                                                                       |
|                                                                                                        | log_es_heap_size: 4g                                                                                                                                                             |
| Bootstrap                                                                                              | hosts: log-es,graylog tag: bootstrap_any,node_exporter                                                                                                                           |
|                                                                                                        | Note: Use multiselect to choose more than one tag                                                                                                                                |
| Monitoring                                                                                             | Deploy Kubernetes Monitoring                                                                                                                                                     |
|                                                                                                        | Note: Ensure the new Log ES and Graylog VM's are available in grafana                                                                                                            |
| Run Graylog Provison Job                                                                               | Choose tags as - openjdk,mongodb-cluster                                                                                                                                         |
|                                                                                                        | Note: Do not choose graylog tag as of now as we want to do some mongo restore first                                                                                              |
| Run GraylogMongoImport job                                                                             | "hosts: graylog graylog_mongo_collections: all"                                                                                                                                  |
| Run LogES provision job                                                                                |                                                                                                                                                                                  |
| Run Graylog Provison Job                                                                               | "Choose tags as - graylog"                                                                                                                                                       |
| Run GraylogGeoIP Job                                                                                   |"graylog_geoip_compressed_file_name: GeoLite2-City_20210413.tar.gz                                                                                                                                                                                 |
|                                                                                                        |graylog_geoip_file_name: GeoLite2-City.mmdb"                                                                                                                                                                                                       |
|                                                                                                        |                                                                                                                                                                                                                                                   |
|                                                                                                        |"Ensure you have uploaded the mmdb                                                                                                                                                                                                                 |
|                                                                                                        |compress file to the same container as the                                                                                                                                                                                                         |
|                                                                                                        |ArtifactUpload job"                                                                                                                                                                                                                                |
|                                                                                                        |                                                                                                                                                                                                                                                   |
|                                                                                                        | "Ensure you change the jenkins job                                                                                                                                                                                                                  |
|                                                                                                        | parameter values as per your file names"                                                                                                                                                                                                            |
| Deploy Kubernetes Logging                                                                              | Choose tag as filebeat                                                                                                                                                                                                                              |
| Deploy Kubernetes Logging                                                                              | Choose tag as oauth2-proxy                                                                                                                                                                                                                          |
|                                                                                                        | "Before deploying the new code, uninstall the chart first helm uninstall -n logging oauth2-proxy"                                                                                                                                                   |
| Deploy nginx public ingress                                                                            | If you have set the variable graylog_open_to_public: true                                                                                                                                                                                           |
| Delete fluent-bit                                                                                      | helm uninstall -n logging fluent-bit                                                                                                                                                                                                                |
| Delete elastisearch-curator cron job                                                                   | helm uninstall -n logging elasticsearch-curator                                                                                                                                                                                                     |
| Deploy Kubernetes Logging                                                                              | Choose tag as kibana                                                                                                                                                                                                                                |
|                                                                                                        | Create a index pattern as * and choose @timestamp field                                                                                                                                                                                             |
| Deploy LoggingFileBeatsVM                                                                              | hosts: choose all tag: defaullt                                                                                                                                                                                                                     |
|                                                                                                        | Run in Kubernetes, KP, DP one after another                                                                                                                                                                                                         |
|                                                                                                        | Dont run in parallel                                                                                                                                                                                                                                |
| Verify logs are flowing                                                                                | Visit GRAYLOG_IP:9000                                                                                                                                                                                                                               |
|                                                                                                        | Can be accessed only via VPN                                                                                                                                                                                                                        |
| Update index set as per your needs                                                                     | Go to System -> Indices -> Default Index Set                                                                                                                                                                                                        |
|                                                                                                        | Change the number of indexes you want to retain based on your ES disk capacity                                                                                                                                                                      |
| Purge old instances of log-es                                                                          |                                                                                                                                                                                                                                                     |
| Delete Kibana after few days                                                                           | helm uninstall -n logging kibana                                                                                                                                                                                                                    |
| "Create the Logging job in datapipeline deploy  folder"                                                | https://github.com/project-sunbird/sunbird-devops/tree/release-3.9.0/deploy/jenkins/jobs/Deploy/jobs/dev/jobs/DataPipeline/jobs/Logging                                                                                                             |
| Deploy Datapipeline logging job                                                                        | Deploy/<env>/DataPipeline/Logging                                                                                                                                                                                                                   |
| Run neo4j cypher script mentioned in link                                                              | https://github.com/project-sunbird/sunbird-learning-platform/blob/release-3.9.0_RC8/docs/cypher-scripts/release-3.9.0.cypher                                                                                                                        |
| Rename KnowledgePlatform job to Learning                                                               | https://github.com/keshavprasadms/sunbird-devops/commit/05d5b54b807ed438e1b7aba4fd25b7e47ebbb93a                                                                                                                                                    |
| Run neo4j cypher script mentioned in link                                                              | https://github.com/project-sunbird/sunbird-learning-platform/blob/release-3.9.0_RC10/docs/cypher-scripts/release-3.9.0.cypher                                                                                                                       |
|                                                                                                        |                                                                                                                                                                                                                                                     |
