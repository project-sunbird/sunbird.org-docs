<!DOCTYPE html>
<html>
    <head>
        <title>DevOps : Core Services</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DevOps</a></span>
                            </li>
                                                    <li>
                                <span><a href="Sunbird-installation---Release-2.0.0_1058537560.html">Sunbird installation - Release 2.0.0</a></span>
                            </li>
                                                    <li>
                                <span><a href="Running-Builds%2C-Artifact-Uploads-and-Deployments_1058930701.html">Running Builds, Artifact Uploads and Deployments</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DevOps : Core Services
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Keshav Prasad</span>, last modified by <span class='editor'> rajesh rajendran</span> on Jul 12, 2019
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h3 id="CoreServices-PREREQUISITES">PREREQUISITES</h3><h3 id="CoreServices-1.Createacontainerinazureblobandmakeitpublicforcontentpublish.Thiscontinernamewillbesameasthevariablesunbird_content_azure_storage_containerwhichisspecifiedinthecommon.ymlofCoreinventory.">1. Create a container in azure blob and make it public for content publish. This continer name will be same as the variable <strong>sunbird_content_azure_storage_container</strong> which is specified in the common.yml of Core inventory.</h3><h3 id="CoreServices-2.SwitchtoBuildfolderandrunalljobs.Providethevalueforgithub_release_tagasperthedetailsmentionedinthispage-CurrentReleaseTagsandJenkinsJobsReference">2. Switch to <code>Build</code><span> </span>folder and run all jobs. Provide the value for <strong>github_release_tag</strong><span> </span>as per the details mentioned in this page - <a style="text-decoration: none;" href="https://project-sunbird.atlassian.net/wiki/spaces/DevOps/pages/1025376293/Current+Release+Tags+and+Jenkins+Jobs+Reference" rel="nofollow">Current Release Tags and Jenkins Jobs Reference</a></h3><p><br/></p><h3 id="CoreServices-RuntheBelowJobs"><strong>Run the Below Jobs</strong></h3><blockquote><h3 id="CoreServices-Belowstepsneedstobefollowedaspertheorder.">Below steps needs to be followed as per the order.</h3></blockquote><p><strong>OpsAdministration</strong>:</p><p>1. Bootstrap                                                                                                               # Creates Deployer User<br/>2. SwarmBootstrap                                                                                                    # Creates Swarm with manager and agent nodes</p><p><strong>Builds</strong>:</p><p>1. Adminutils                                                                                                              # Builds Adminutils container<br/>2. API MANAGER                                                                                                      # Builds API Manager Container<br/>3. API MANAGER Echo                                                                                             # Builds API Manager echo Container<br/>4. Badger                                                                                                                  # Builds Badger Container<br/>5. Cassandra                                                                                                            # Creates a jar for migration purpose<br/>6. Content                                                                                                                 # Builds Content Service Container<br/>7. Learner                                                                                                                 # Builds Learner Service Container<br/>8. Player                                                                                                                   # Builds Player Service Container<br/>9. Proxy                                                                                                                    # Builds Proxy container<br/>10. Telemetry                                                                                                           # Builds Telemetry container</p><p><strong>Artifacts</strong>:<br/>(Make Sure all Artifacts are uploaded)</p><p><strong>Provision</strong>:</p><p>1. (Deploy) ApplicationES                                                                                          # From Deploy Folder Deploy ApplicationES this will Provision Elasticsearch and create indices necessay for Sunbird Core</p><p>2. ESMapping (Under OpsAdministarion)                                                                  # Creates ES indexes</p><p>2. Postgres                                                                                                                # Provisions Postgres</p><p>3. PostgresDbUpdate                                                                                                # Creates the databases, assign roles, create users</p><p><br/></p><p><strong>Deploy</strong>:</p><p>1. Adminutil                                                                                                               # Deploy Adminutil Container<br/>2. API Manager                                                                                                         # deploys API Manger Kong and API manager echo<br/>4. OnboardAPIS                                                                                                        # Onboards All API's to sunbird<br/>5. OnboardConsumers (Take the <strong>jwt token</strong> from Jenkins Output of <strong>api-management-test-user</strong> and update  <strong>core_vault_sunbird_api_auth_token</strong> if using KP and DP along with core) # Onboards New consumer to sunbird and generates API key specific to Consumer, <strong>Update this value with correponding api key of ekstep 'core_vault_ekstep_api_key'</strong> <br/>7. (Provision) Cassandra                                                                                           # Provisions Cassandra and create Keyspaces required for Sunbird Core<br/>8. Cassandra                                                                                                             # Does Migration if required<br/>6. (Provision) Keycloak                                                                                              # Provisions Keycloak by installing prerequisites like java and env vars of learner<br/>9. keycloak                                                                                                                 # Deploys keycloak service to VM<br/>10. Proxy                                                                                                                   # Deploys Proxy, Handles all routing within the swarm<br/>11. KeycloakRealm                                                                                                   # Creates Sunbird Realm, (After Creation of Realm configure keycloak by using Below Steps.)</p><h3 id="CoreServices-ConfigurationStepsRequiredinKeycloak"><strong>Configuration Steps Required in Keycloak</strong></h3><p>  a. Login to keycloak using username admin and password as given in private &quot;secrets.yml&quot; file. # Login to keycloak by using &lt;domainname&gt;/auth<br/>  b. Take the sso_public_key by navigating to: sunbird Realm &gt; Realm Settings &gt; keys &gt; click Public Key(copy the key and update core_vault_sso_public_key)<br/>  c. Create Admin Role in Sunbird realm: Roles &gt; Add Role &gt; add details in the form(Role Name: admin) &gt; save &gt; Enable Composite Roles &gt; Under Composite Roles &gt; Select (offline_access, uma_administration) and click add selected,  Permissions(enable Permissions).<br/>  d. Assign permissions to admin-cli client in Sunbird realm: clients &gt; admin-cli &gt; Settings &gt; Implicit Flow Enabled (ON) &gt; Root URL: <a href="https://dev.sunbird.cf" class="external-link" rel="nofollow">https://dev.sunbird.cf</a> (your Domain) &gt; Valid Redirect URIs: <a href="https://dev.sunbird.cf/*" class="external-link" rel="nofollow">https://dev.sunbird.cf/*</a> (Add another Link by clicking on &quot;+&quot;) &gt; Valid Redirect URIs: <a href="https://dev.sunbird.cf/" class="external-link" rel="nofollow">https://dev.sunbird.cf/</a> &gt; Base URL: / &gt; Admin URL: <a href="https://dev.sunbird.cf/*" class="external-link" rel="nofollow">https://dev.sunbird.cf/*</a> &gt; Save<br/>  e. In the Sunbird realm, Clients &gt; admin-cli &gt; Roles &gt; Add Role: Role Name: admin (Save)&gt; composite Roles (ON) &gt; Composite Roles &gt; Realm Roles &gt; add admin,offline_access,uma_authorization &gt; Permissions &gt; Permissions Enabled (ON)</p><p>  f. Creating keycloak federation (<a href="https://project-sunbird.atlassian.net/wiki/spaces/SBDES/pages/1021673496/Deployment+Steps+for+Keycloak+User+Federation" data-linked-resource-id="1021673496" data-linked-resource-version="15" data-linked-resource-type="page">Deployment Steps for Keycloak User Federation</a>)</p><p>12. Player                                                                                                                    # Deploys Player service, used to display Frontend of App</p><p><strong>Note: </strong>This player deployment job will fail first time and Jenkins will ask for <strong>In process Approval Script. Click on the approval link in the deploy job page and provide explicit approval for new <span style="color: rgb(0,0,128);"><u>java.io.File java.lang.String</u></span> and <span style="color: rgb(0,0,128);"><u>method java.io.File</u><u> exists</u></span></strong><span style="color: rgb(0,0,0);">. Now rerun Player deployment.</span><strong><br/></strong></p><p>13. Learner                                                                                                                 # Deploys Learner Service, handles user management, helps in searching content<br/>14. Content                                                                                                                 # Deploys Content service, Helps in creation of content<br/>15. Telemetry                                                                                                              # Deploys Telemetry Service, Helps in sending telemetry to kafka<br/>16. TelemetryLogstashDataPipeline                                                                                           # Deploys logstash container, which sends telemetry to kafka</p><p>17. TelemetryLogstash                                                                                               # Deploys logstash container for sending telemetry to ekstep [Trigger only when you want to send telemetry to ekstep]</p><h3 id="CoreServices-Createamappingforcbatchelasticsearchsearchindexindex"><strong>Create a mapping for cbatch elasticsearch searchindex index</strong></h3><ul><li>Follow this documentation and create mappings for cbatch searchindex index. [<a href="http://402.qa.docs.sunbird.org/master/developer-docs/configuring_sunbird/elasticsearch_static_mapping_course_batch/" class="external-link" rel="nofollow">http://402.qa.docs.sunbird.org/master/developer-docs/configuring_sunbird/elasticsearch_static_mapping_course_batch/</a>]</li></ul>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Jul 16, 2019 18:44</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
